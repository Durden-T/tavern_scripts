import{createPinia as e,defineStore as t,storeToRefs as n}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as r}from'https://testingcf.jsdelivr.net/npm/klona/+esm';import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';var a={266(e,t,n){var r=n(969);r.__esModule&&(r=r.default),'string'==typeof r&&(r=[[e.id,r,'']]),r.locals&&(e.exports=r.locals);(0,n(424).A)('6cc08a2c',r,!1,{ssrId:!0})},424(e,t,n){function r(e,t){for(var n=[],r={},a=0;a<t.length;a++){var l=t[a],o=l[0],i={id:e+':'+a,css:l[1],media:l[2],sourceMap:l[3]};r[o]?r[o].parts.push(i):n.push(r[o]={id:o,parts:[i]})}return n}n.d(t,{A:()=>p});var a='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!a)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var l={},o=a&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,d=!1,c=function(){},u=null,m='data-vue-ssr-id',f='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function p(e,t,n,a){d=n,u=a||{};var o=r(e,t);return b(o),function(t){for(var n=[],a=0;a<o.length;a++){var i=o[a];(s=l[i.id]).refs--,n.push(s)}t?b(o=r(e,t)):o=[];for(a=0;a<n.length;a++){var s;if(0===(s=n[a]).refs){for(var d=0;d<s.parts.length;d++)s.parts[d]();delete l[s.id]}}}}function b(e){for(var t=0;t<e.length;t++){var n=e[t],r=l[n.id];if(r){r.refs++;for(var a=0;a<r.parts.length;a++)r.parts[a](n.parts[a]);for(;a<n.parts.length;a++)r.parts.push(v(n.parts[a]));r.parts.length>n.parts.length&&(r.parts.length=n.parts.length)}else{var o=[];for(a=0;a<n.parts.length;a++)o.push(v(n.parts[a]));l[n.id]={id:n.id,refs:1,parts:o}}}}function y(){var e=document.createElement('style');return e.type='text/css',o.appendChild(e),e}function v(e){var t,n,r=document.querySelector('style['+m+'~="'+e.id+'"]');if(r){if(d)return c;r.parentNode.removeChild(r)}if(f){var a=s++;r=i||(i=y()),t=g.bind(null,r,a,!1),n=g.bind(null,r,a,!0)}else r=y(),t=E.bind(null,r),n=function(){r.parentNode.removeChild(r)};return t(e),function(r){if(r){if(r.css===e.css&&r.media===e.media&&r.sourceMap===e.sourceMap)return;t(e=r)}else n()}}var x,h=(x=[],function(e,t){return x[e]=t,x.filter(Boolean).join('\n')});function g(e,t,n,r){var a=n?'':r.css;if(e.styleSheet)e.styleSheet.cssText=h(t,a);else{var l=document.createTextNode(a),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(l,o[t]):e.appendChild(l)}}function E(e,t){var n=t.css,r=t.media,a=t.sourceMap;if(r&&e.setAttribute('media',r),u.ssrId&&e.setAttribute(m,t.id),a&&(n+='\n/*# sourceURL='+a.sources[0]+' */',n+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(a))))+' */'),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}},455(e,t){t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,r]of t)n[e]=r;return n}},492(e){e.exports=function(e){var t=e[1],n=e[3];if(!n)return t;if('function'==typeof btoa){var r=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),a='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(r),l='/*# '.concat(a,' */');return[t].concat([l]).join('\n')}return[t].join('\n')}},748(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n='',r=void 0!==t[5];return t[4]&&(n+='@supports ('.concat(t[4],') {')),t[2]&&(n+='@media '.concat(t[2],' {')),r&&(n+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),n+=e(t),r&&(n+='}'),t[2]&&(n+='}'),t[4]&&(n+='}'),n}).join('')},t.i=function(e,n,r,a,l){'string'==typeof e&&(e=[[null,e,void 0]]);var o={};if(r)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(o[s]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);r&&o[c[0]]||(void 0!==l&&(void 0===c[5]||(c[1]='@layer'.concat(c[5].length>0?' '.concat(c[5]):'',' {').concat(c[1],'}')),c[5]=l),n&&(c[2]?(c[1]='@media '.concat(c[2],' {').concat(c[1],'}'),c[2]=n):c[2]=n),a&&(c[4]?(c[1]='@supports ('.concat(c[4],') {').concat(c[1],'}'),c[4]=a):c[4]=''.concat(a)),t.push(c))}},t}},969(e,t,n){n.r(t),n.d(t,{default:()=>i});var r=n(492),a=n.n(r),l=n(748),o=n.n(l)()(a());o.push([e.id,'.auto-retry-settings[data-v-9651185c]{margin-bottom:10px}.auto-retry-settings h4[data-v-9651185c]{margin:10px 0 5px 0;font-weight:bold}.auto-retry-settings .flex-container[data-v-9651185c]{margin-bottom:5px}.auto-retry-settings label[data-v-9651185c]{min-width:150px}.fallback-model-entry[data-v-9651185c]{padding:10px;margin:5px 0;border:1px solid var(--SmartThemeBorderColor);border-radius:5px}\n','',{version:3,sources:['webpack://./src/auto-retry/SettingsPanel.vue'],names:[],mappings:'AAqPA,sCACE,kBACF,CAEA,yCACE,mBAAoB,CACpB,gBACF,CAEA,sDACE,iBACF,CAEA,4CACE,eACF,CAEA,uCACE,YAAa,CACb,YAAa,CACb,6CAA8C,CAC9C,iBACF',sourcesContent:['<template>\n  <div class="auto-retry-settings">\n    <div class="inline-drawer">\n      <div class="inline-drawer-toggle inline-drawer-header">\n        <b>Auto-Retry Settings</b>\n        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n      </div>\n      <div class="inline-drawer-content">\n        <div class="flex-container flexFlowColumn">\n          <div class="flex-container">\n            <input id="auto-retry-enabled" v-model="settings.enabled" type="checkbox" />\n            <label for="auto-retry-enabled">Enable Auto-Retry</label>\n          </div>\n\n          <hr class="sysHR" />\n\n          <h4>Retry Configuration</h4>\n\n          <div class="flex-container">\n            <label for="auto-retry-max-retries">Max Retries:</label>\n            <input\n              id="auto-retry-max-retries"\n              v-model.number="settings.maxRetries"\n              type="number"\n              min="1"\n              max="20"\n              class="text_pole"\n            />\n          </div>\n\n          <div class="flex-container">\n            <label for="auto-retry-delay">Retry Delay (ms):</label>\n            <input\n              id="auto-retry-delay"\n              v-model.number="settings.retryDelayMs"\n              type="number"\n              min="100"\n              max="60000"\n              class="text_pole"\n            />\n          </div>\n\n          <div class="flex-container">\n            <label for="auto-retry-multiplier">Delay Multiplier:</label>\n            <input\n              id="auto-retry-multiplier"\n              v-model.number="settings.retryDelayMultiplier"\n              type="number"\n              min="1"\n              max="5"\n              step="0.1"\n              class="text_pole"\n            />\n          </div>\n\n          <hr class="sysHR" />\n\n          <h4>Rate Limit (429) Configuration</h4>\n\n          <div class="flex-container">\n            <label for="auto-retry-rate-limit-delay">Rate Limit Delay (ms):</label>\n            <input\n              id="auto-retry-rate-limit-delay"\n              v-model.number="settings.rateLimitDelayMs"\n              type="number"\n              min="1000"\n              max="300000"\n              class="text_pole"\n            />\n          </div>\n\n          <div class="flex-container">\n            <label for="auto-retry-rate-limit-max">Rate Limit Max Retries:</label>\n            <input\n              id="auto-retry-rate-limit-max"\n              v-model.number="settings.rateLimitMaxRetries"\n              type="number"\n              min="1"\n              max="10"\n              class="text_pole"\n            />\n          </div>\n\n          <hr class="sysHR" />\n\n          <h4>Timeout Configuration</h4>\n\n          <div class="flex-container">\n            <label for="auto-retry-streaming-timeout">Streaming Timeout (ms):</label>\n            <input\n              id="auto-retry-streaming-timeout"\n              v-model.number="settings.streamingTimeoutMs"\n              type="number"\n              min="5000"\n              max="300000"\n              class="text_pole"\n            />\n          </div>\n\n          <hr class="sysHR" />\n\n          <h4>Content Validation</h4>\n\n          <div class="flex-container">\n            <input id="auto-retry-content-enabled" v-model="settings.requiredContentEnabled" type="checkbox" />\n            <label for="auto-retry-content-enabled">Enable Content Validation</label>\n          </div>\n\n          <div v-if="settings.requiredContentEnabled" class="flex-container flexFlowColumn">\n            <div class="flex-container">\n              <label for="auto-retry-content-pattern">Required Pattern:</label>\n              <input\n                id="auto-retry-content-pattern"\n                v-model="settings.requiredContentPattern"\n                type="text"\n                class="text_pole wide100p"\n                placeholder="e.g. ```json or regex pattern"\n              />\n            </div>\n            <div class="flex-container">\n              <input id="auto-retry-content-regex" v-model="settings.requiredContentIsRegex" type="checkbox" />\n              <label for="auto-retry-content-regex">Use Regex</label>\n            </div>\n          </div>\n\n          <hr class="sysHR" />\n\n          <h4>Fallback Models</h4>\n\n          <div class="flex-container">\n            <input id="auto-retry-fallback-enabled" v-model="settings.fallbackModelsEnabled" type="checkbox" />\n            <label for="auto-retry-fallback-enabled">Enable Fallback Models</label>\n          </div>\n\n          <div v-if="settings.fallbackModelsEnabled" class="flex-container flexFlowColumn">\n            <div v-for="(model, index) in settings.fallbackModels" :key="index" class="fallback-model-entry">\n              <div class="flex-container">\n                <label>API URL:</label>\n                <input v-model="model.apiurl" type="text" class="text_pole wide100p" />\n              </div>\n              <div class="flex-container">\n                <label>API Key:</label>\n                <input v-model="model.key" type="password" class="text_pole wide100p" />\n              </div>\n              <div class="flex-container">\n                <label>Model:</label>\n                <input v-model="model.model" type="text" class="text_pole wide100p" />\n              </div>\n              <div class="flex-container">\n                <label>Source:</label>\n                <input v-model="model.source" type="text" class="text_pole" placeholder="openai" />\n              </div>\n              <input type="button" class="menu_button" value="Remove" @click="removeFallbackModel(index)" />\n              <hr class="sysHR" />\n            </div>\n            <input type="button" class="menu_button" value="Add Fallback Model" @click="addFallbackModel" />\n          </div>\n\n          <hr class="sysHR" />\n\n          <h4>Generation ID Filter</h4>\n\n          <div class="flex-container">\n            <input id="auto-retry-filter-enabled" v-model="settings.filterEnabled" type="checkbox" />\n            <label for="auto-retry-filter-enabled">Enable Filter</label>\n          </div>\n\n          <div v-if="settings.filterEnabled" class="flex-container flexFlowColumn">\n            <div class="flex-container">\n              <label for="auto-retry-filter-mode">Filter Mode:</label>\n              <select id="auto-retry-filter-mode" v-model="settings.filterMode" class="text_pole">\n                <option value="blacklist">Blacklist (exclude listed)</option>\n                <option value="whitelist">Whitelist (only listed)</option>\n              </select>\n            </div>\n            <div class="flex-container">\n              <label for="auto-retry-filter-ids">Generation IDs (comma-separated):</label>\n              <input\n                id="auto-retry-filter-ids"\n                v-model="filterIdsString"\n                type="text"\n                class="text_pole wide100p"\n                placeholder="e.g. background-summary, auto-continue"\n              />\n            </div>\n          </div>\n\n          <hr class="sysHR" />\n\n          <h4>Notifications</h4>\n\n          <div class="flex-container">\n            <input id="auto-retry-toast-retry" v-model="settings.showRetryToast" type="checkbox" />\n            <label for="auto-retry-toast-retry">Show Retry Toast</label>\n          </div>\n\n          <div class="flex-container">\n            <input id="auto-retry-toast-success" v-model="settings.showSuccessToast" type="checkbox" />\n            <label for="auto-retry-toast-success">Show Success Toast</label>\n          </div>\n\n          <div class="flex-container">\n            <input id="auto-retry-toast-failure" v-model="settings.showFailureToast" type="checkbox" />\n            <label for="auto-retry-toast-failure">Show Failure Toast</label>\n          </div>\n\n          <hr class="sysHR" />\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script setup lang="ts">\nimport { storeToRefs } from \'pinia\';\nimport { useSettingsStore } from \'./settings\';\n\nconst store = useSettingsStore();\nconst { settings } = storeToRefs(store);\n\nconst filterIdsString = computed({\n  get: () => settings.value.filterGenerationIds.join(\', \'),\n  set: (val: string) => {\n    settings.value.filterGenerationIds = val\n      .split(\',\')\n      .map(s => s.trim())\n      .filter(s => s.length > 0);\n  },\n});\n\nfunction addFallbackModel() {\n  settings.value.fallbackModels.push({\n    apiurl: \'\',\n    key: \'\',\n    model: \'\',\n    source: \'openai\',\n  });\n}\n\nfunction removeFallbackModel(index: number) {\n  settings.value.fallbackModels.splice(index, 1);\n}\n<\/script>\n\n<style scoped>\n.auto-retry-settings {\n  margin-bottom: 10px;\n}\n\n.auto-retry-settings h4 {\n  margin: 10px 0 5px 0;\n  font-weight: bold;\n}\n\n.auto-retry-settings .flex-container {\n  margin-bottom: 5px;\n}\n\n.auto-retry-settings label {\n  min-width: 150px;\n}\n\n.fallback-model-entry {\n  padding: 10px;\n  margin: 5px 0;\n  border: 1px solid var(--SmartThemeBorderColor);\n  border-radius: 5px;\n}\n</style>\n'],sourceRoot:''}]);const i=o}},l={};function o(e){var t=l[e];if(void 0!==t)return t.exports;var n=l[e]={id:e,exports:{}};return a[e](n,n.exports,o),n.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const i=Vue,s=z,d=s.z.object({apiurl:s.z.string(),key:s.z.string(),model:s.z.string(),source:s.z.string().default('openai')}),c=s.z.object({enabled:s.z.boolean().default(!0),maxRetries:s.z.number().int().min(1).max(20).default(3),retryDelayMs:s.z.number().int().min(100).max(6e4).default(1e3),retryDelayMultiplier:s.z.number().min(1).max(5).default(1.5),rateLimitDelayMs:s.z.number().int().min(1e3).max(3e5).default(3e4),rateLimitMaxRetries:s.z.number().int().min(1).max(10).default(5),streamingTimeoutMs:s.z.number().int().min(5e3).max(3e5).default(3e4),requiredContentEnabled:s.z.boolean().default(!1),requiredContentPattern:s.z.string().default(''),requiredContentIsRegex:s.z.boolean().default(!1),fallbackModelsEnabled:s.z.boolean().default(!1),fallbackModels:s.z.array(d).default([]),filterEnabled:s.z.boolean().default(!1),filterMode:s.z.enum(['whitelist','blacklist']).default('blacklist'),filterGenerationIds:s.z.array(s.z.string()).default([]),showRetryToast:s.z.boolean().default(!0),showSuccessToast:s.z.boolean().default(!0),showFailureToast:s.z.boolean().default(!0)}).prefault({}),u=t('auto-retry-settings',()=>{const e=(0,i.ref)(c.parse(getVariables({type:'script',script_id:getScriptId()})));return(0,i.watchEffect)(()=>{insertOrAssignVariables(r(e.value),{type:'script',script_id:getScriptId()})}),{settings:e,toggle:function(){e.value.enabled=!e.value.enabled}}}),m={class:'auto-retry-settings'},f={class:'inline-drawer'},p={class:'inline-drawer-content'},b={class:'flex-container flexFlowColumn'},y={class:'flex-container'},v={class:'flex-container'},x={class:'flex-container'},h={class:'flex-container'},g={class:'flex-container'},E={class:'flex-container'},w={class:'flex-container'},k={class:'flex-container'},V={key:0,class:'flex-container flexFlowColumn'},C={class:'flex-container'},M={class:'flex-container'},N={class:'flex-container'},R={key:1,class:'flex-container flexFlowColumn'},T={class:'flex-container'},A=['onUpdate:modelValue'],D={class:'flex-container'},S=['onUpdate:modelValue'],F={class:'flex-container'},I=['onUpdate:modelValue'],U={class:'flex-container'},B=['onUpdate:modelValue'],q=['onClick'],L={class:'flex-container'},j={key:2,class:'flex-container flexFlowColumn'},P={class:'flex-container'},H={class:'flex-container'},O={class:'flex-container'},G={class:'flex-container'},W={class:'flex-container'},K=(0,i.defineComponent)({__name:'SettingsPanel',setup(e){const t=u(),{settings:r}=n(t),a=(0,i.computed)({get:()=>r.value.filterGenerationIds.join(', '),set:e=>{r.value.filterGenerationIds=e.split(',').map(e=>e.trim()).filter(e=>e.length>0)}});function l(){r.value.fallbackModels.push({apiurl:'',key:'',model:'',source:'openai'})}return(e,t)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',m,[(0,i.createElementVNode)('div',f,[t[55]||(t[55]=(0,i.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,i.createElementVNode)('b',null,'Auto-Retry Settings'),(0,i.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,i.createElementVNode)('div',p,[(0,i.createElementVNode)('div',b,[(0,i.createElementVNode)('div',y,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-enabled','onUpdate:modelValue':t[0]||(t[0]=e=>(0,i.unref)(r).enabled=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(r).enabled]]),t[17]||(t[17]=(0,i.createElementVNode)('label',{for:'auto-retry-enabled'},'Enable Auto-Retry',-1))]),t[40]||(t[40]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1)),t[41]||(t[41]=(0,i.createElementVNode)('h4',null,'Retry Configuration',-1)),(0,i.createElementVNode)('div',v,[t[18]||(t[18]=(0,i.createElementVNode)('label',{for:'auto-retry-max-retries'},'Max Retries:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-max-retries','onUpdate:modelValue':t[1]||(t[1]=e=>(0,i.unref)(r).maxRetries=e),type:'number',min:'1',max:'20',class:'text_pole'},null,512),[[i.vModelText,(0,i.unref)(r).maxRetries,void 0,{number:!0}]])]),(0,i.createElementVNode)('div',x,[t[19]||(t[19]=(0,i.createElementVNode)('label',{for:'auto-retry-delay'},'Retry Delay (ms):',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-delay','onUpdate:modelValue':t[2]||(t[2]=e=>(0,i.unref)(r).retryDelayMs=e),type:'number',min:'100',max:'60000',class:'text_pole'},null,512),[[i.vModelText,(0,i.unref)(r).retryDelayMs,void 0,{number:!0}]])]),(0,i.createElementVNode)('div',h,[t[20]||(t[20]=(0,i.createElementVNode)('label',{for:'auto-retry-multiplier'},'Delay Multiplier:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-multiplier','onUpdate:modelValue':t[3]||(t[3]=e=>(0,i.unref)(r).retryDelayMultiplier=e),type:'number',min:'1',max:'5',step:'0.1',class:'text_pole'},null,512),[[i.vModelText,(0,i.unref)(r).retryDelayMultiplier,void 0,{number:!0}]])]),t[42]||(t[42]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1)),t[43]||(t[43]=(0,i.createElementVNode)('h4',null,'Rate Limit (429) Configuration',-1)),(0,i.createElementVNode)('div',g,[t[21]||(t[21]=(0,i.createElementVNode)('label',{for:'auto-retry-rate-limit-delay'},'Rate Limit Delay (ms):',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-rate-limit-delay','onUpdate:modelValue':t[4]||(t[4]=e=>(0,i.unref)(r).rateLimitDelayMs=e),type:'number',min:'1000',max:'300000',class:'text_pole'},null,512),[[i.vModelText,(0,i.unref)(r).rateLimitDelayMs,void 0,{number:!0}]])]),(0,i.createElementVNode)('div',E,[t[22]||(t[22]=(0,i.createElementVNode)('label',{for:'auto-retry-rate-limit-max'},'Rate Limit Max Retries:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-rate-limit-max','onUpdate:modelValue':t[5]||(t[5]=e=>(0,i.unref)(r).rateLimitMaxRetries=e),type:'number',min:'1',max:'10',class:'text_pole'},null,512),[[i.vModelText,(0,i.unref)(r).rateLimitMaxRetries,void 0,{number:!0}]])]),t[44]||(t[44]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1)),t[45]||(t[45]=(0,i.createElementVNode)('h4',null,'Timeout Configuration',-1)),(0,i.createElementVNode)('div',w,[t[23]||(t[23]=(0,i.createElementVNode)('label',{for:'auto-retry-streaming-timeout'},'Streaming Timeout (ms):',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-streaming-timeout','onUpdate:modelValue':t[6]||(t[6]=e=>(0,i.unref)(r).streamingTimeoutMs=e),type:'number',min:'5000',max:'300000',class:'text_pole'},null,512),[[i.vModelText,(0,i.unref)(r).streamingTimeoutMs,void 0,{number:!0}]])]),t[46]||(t[46]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1)),t[47]||(t[47]=(0,i.createElementVNode)('h4',null,'Content Validation',-1)),(0,i.createElementVNode)('div',k,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-content-enabled','onUpdate:modelValue':t[7]||(t[7]=e=>(0,i.unref)(r).requiredContentEnabled=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(r).requiredContentEnabled]]),t[24]||(t[24]=(0,i.createElementVNode)('label',{for:'auto-retry-content-enabled'},'Enable Content Validation',-1))]),(0,i.unref)(r).requiredContentEnabled?((0,i.openBlock)(),(0,i.createElementBlock)('div',V,[(0,i.createElementVNode)('div',C,[t[25]||(t[25]=(0,i.createElementVNode)('label',{for:'auto-retry-content-pattern'},'Required Pattern:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-content-pattern','onUpdate:modelValue':t[8]||(t[8]=e=>(0,i.unref)(r).requiredContentPattern=e),type:'text',class:'text_pole wide100p',placeholder:'e.g. ```json or regex pattern'},null,512),[[i.vModelText,(0,i.unref)(r).requiredContentPattern]])]),(0,i.createElementVNode)('div',M,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-content-regex','onUpdate:modelValue':t[9]||(t[9]=e=>(0,i.unref)(r).requiredContentIsRegex=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(r).requiredContentIsRegex]]),t[26]||(t[26]=(0,i.createElementVNode)('label',{for:'auto-retry-content-regex'},'Use Regex',-1))])])):(0,i.createCommentVNode)('v-if',!0),t[48]||(t[48]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1)),t[49]||(t[49]=(0,i.createElementVNode)('h4',null,'Fallback Models',-1)),(0,i.createElementVNode)('div',N,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-fallback-enabled','onUpdate:modelValue':t[10]||(t[10]=e=>(0,i.unref)(r).fallbackModelsEnabled=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(r).fallbackModelsEnabled]]),t[27]||(t[27]=(0,i.createElementVNode)('label',{for:'auto-retry-fallback-enabled'},'Enable Fallback Models',-1))]),(0,i.unref)(r).fallbackModelsEnabled?((0,i.openBlock)(),(0,i.createElementBlock)('div',R,[((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)((0,i.unref)(r).fallbackModels,(e,n)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:n,class:'fallback-model-entry'},[(0,i.createElementVNode)('div',T,[t[28]||(t[28]=(0,i.createElementVNode)('label',null,'API URL:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t=>e.apiurl=t,type:'text',class:'text_pole wide100p'},null,8,A),[[i.vModelText,e.apiurl]])]),(0,i.createElementVNode)('div',D,[t[29]||(t[29]=(0,i.createElementVNode)('label',null,'API Key:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t=>e.key=t,type:'password',class:'text_pole wide100p'},null,8,S),[[i.vModelText,e.key]])]),(0,i.createElementVNode)('div',F,[t[30]||(t[30]=(0,i.createElementVNode)('label',null,'Model:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t=>e.model=t,type:'text',class:'text_pole wide100p'},null,8,I),[[i.vModelText,e.model]])]),(0,i.createElementVNode)('div',U,[t[31]||(t[31]=(0,i.createElementVNode)('label',null,'Source:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t=>e.source=t,type:'text',class:'text_pole',placeholder:'openai'},null,8,B),[[i.vModelText,e.source]])]),(0,i.createElementVNode)('input',{type:'button',class:'menu_button',value:'Remove',onClick:e=>function(e){r.value.fallbackModels.splice(e,1)}(n)},null,8,q),t[32]||(t[32]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1))]))),128)),(0,i.createElementVNode)('input',{type:'button',class:'menu_button',value:'Add Fallback Model',onClick:l})])):(0,i.createCommentVNode)('v-if',!0),t[50]||(t[50]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1)),t[51]||(t[51]=(0,i.createElementVNode)('h4',null,'Generation ID Filter',-1)),(0,i.createElementVNode)('div',L,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-filter-enabled','onUpdate:modelValue':t[11]||(t[11]=e=>(0,i.unref)(r).filterEnabled=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(r).filterEnabled]]),t[33]||(t[33]=(0,i.createElementVNode)('label',{for:'auto-retry-filter-enabled'},'Enable Filter',-1))]),(0,i.unref)(r).filterEnabled?((0,i.openBlock)(),(0,i.createElementBlock)('div',j,[(0,i.createElementVNode)('div',P,[t[35]||(t[35]=(0,i.createElementVNode)('label',{for:'auto-retry-filter-mode'},'Filter Mode:',-1)),(0,i.withDirectives)((0,i.createElementVNode)('select',{id:'auto-retry-filter-mode','onUpdate:modelValue':t[12]||(t[12]=e=>(0,i.unref)(r).filterMode=e),class:'text_pole'},[...t[34]||(t[34]=[(0,i.createElementVNode)('option',{value:'blacklist'},'Blacklist (exclude listed)',-1),(0,i.createElementVNode)('option',{value:'whitelist'},'Whitelist (only listed)',-1)])],512),[[i.vModelSelect,(0,i.unref)(r).filterMode]])]),(0,i.createElementVNode)('div',H,[t[36]||(t[36]=(0,i.createElementVNode)('label',{for:'auto-retry-filter-ids'},'Generation IDs (comma-separated):',-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-filter-ids','onUpdate:modelValue':t[13]||(t[13]=e=>(0,i.isRef)(a)?a.value=e:null),type:'text',class:'text_pole wide100p',placeholder:'e.g. background-summary, auto-continue'},null,512),[[i.vModelText,(0,i.unref)(a)]])])])):(0,i.createCommentVNode)('v-if',!0),t[52]||(t[52]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1)),t[53]||(t[53]=(0,i.createElementVNode)('h4',null,'Notifications',-1)),(0,i.createElementVNode)('div',O,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-toast-retry','onUpdate:modelValue':t[14]||(t[14]=e=>(0,i.unref)(r).showRetryToast=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(r).showRetryToast]]),t[37]||(t[37]=(0,i.createElementVNode)('label',{for:'auto-retry-toast-retry'},'Show Retry Toast',-1))]),(0,i.createElementVNode)('div',G,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-toast-success','onUpdate:modelValue':t[15]||(t[15]=e=>(0,i.unref)(r).showSuccessToast=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(r).showSuccessToast]]),t[38]||(t[38]=(0,i.createElementVNode)('label',{for:'auto-retry-toast-success'},'Show Success Toast',-1))]),(0,i.createElementVNode)('div',W,[(0,i.withDirectives)((0,i.createElementVNode)('input',{id:'auto-retry-toast-failure','onUpdate:modelValue':t[16]||(t[16]=e=>(0,i.unref)(r).showFailureToast=e),type:'checkbox'},null,512),[[i.vModelCheckbox,(0,i.unref)(r).showFailureToast]]),t[39]||(t[39]=(0,i.createElementVNode)('label',{for:'auto-retry-toast-failure'},'Show Failure Toast',-1))]),t[54]||(t[54]=(0,i.createElementVNode)('hr',{class:'sysHR'},null,-1))])])])]))}});o(266);const Y=(0,o(455).A)(K,[['__scopeId','data-v-9651185c']]);const J=new Map;function Q(e){if(e instanceof Error){const t=e.message.toLowerCase();if(t.includes('rate limit')||t.includes('too many requests')||t.includes('quota exceeded'))return!0}if('object'==typeof e&&null!==e){if(429===(e.status??e.statusCode))return!0}return!1}function X(e){if(Q(e))return!0;if(e instanceof Error){const t=e.message.toLowerCase();if(t.includes('network')||t.includes('fetch')||t.includes('timeout')||t.includes('connection refused')||t.includes('connection reset')||t.includes('econnrefused')||t.includes('econnreset'))return!0}if('object'==typeof e&&null!==e){const t=e.status??e.statusCode;if('number'==typeof t&&t>=500&&t<600)return!0}return!1}function Z(e,t){if(!t.requiredContentEnabled||!t.requiredContentPattern)return!0;if(t.requiredContentIsRegex)try{return new RegExp(t.requiredContentPattern).test(e)}catch{return console.warn('[auto-retry] Invalid regex pattern:',t.requiredContentPattern),!0}return e.includes(t.requiredContentPattern)}async function ee(e,t,n,r,a,l){const o=t.generation_id??'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)}),i=t.should_stream??!1;if(!function(e,t){if(!t.filterEnabled)return!0;const n=t.filterGenerationIds.includes(e);return'whitelist'===t.filterMode?n:!n}(o,n))try{return{success:!0,result:await e(),attempts:1,usedFallback:!1}}catch(e){return{success:!1,error:e,attempts:1,usedFallback:!1}}const s={generationId:o,isStreaming:i,config:t,aborted:!1,lastTokenTime:Date.now(),hasReceivedContent:!1,startTime:Date.now()};J.set(o,s);try{const o=await async function(e,t,n,r,a,l,o){let i,s,d=0,c=t,u=e,m=!1,f=-1;const p=n.maxRetries;for(;d<p;){if(r.aborted)return{success:!1,error:new Error('Aborted by user'),attempts:d,usedFallback:m};d++,r.lastTokenTime=Date.now(),r.hasReceivedContent=!1,r.startTime=Date.now(),n.showRetryToast&&d>1&&toastr.info(`Auto-retry: Attempt ${d}/${p}...`);try{const e=u(),t=await te(e,r,n);if('string'==typeof t&&!Z(t,n)){n.showRetryToast&&toastr.warning('Response missing required content. Retrying...'),i=new Error('Content validation failed'),await ne(d,n,!1);continue}return n.showSuccessToast&&d>1&&toastr.success(`Auto-retry succeeded on attempt ${d}`),{success:!0,result:t,attempts:d,usedFallback:m,fallbackModel:s}}catch(e){if(i=e,console.warn(`[auto-retry] Attempt ${d} failed:`,e),r.aborted)return{success:!1,error:new Error('Aborted by user'),attempts:d,usedFallback:m};if(!X(e))break;const t=Q(e);if(d>=(t?n.rateLimitMaxRetries:p))break;if(t&&n.showRetryToast){const e=Math.round(n.rateLimitDelayMs/1e3);toastr.warning(`Rate limited. Waiting ${e}s...`)}await ne(d,n,t)}}if(n.fallbackModelsEnabled&&n.fallbackModels.length>0)for(let e=0;e<n.fallbackModels.length;e++){const t=n.fallbackModels[e];if(!t.apiurl||!t.model){console.warn(`[auto-retry] Skipping invalid fallback model at index ${e}`);continue}f=e,m=!0,s=t,n.showRetryToast&&toastr.info(`Trying fallback model: ${t.model}...`);const b={...c,custom_api:{apiurl:t.apiurl,key:t.key,model:t.model,source:t.source}};for(c=b,u=o?()=>l(b):()=>a(b),d=0;d<p;){if(r.aborted)return{success:!1,error:new Error('Aborted by user'),attempts:d,usedFallback:m,fallbackModel:s};d++,r.lastTokenTime=Date.now(),r.hasReceivedContent=!1,r.startTime=Date.now(),n.showRetryToast&&d>1&&toastr.info(`Auto-retry (fallback ${f+1}): Attempt ${d}/${p}...`);try{const e=u(),a=await te(e,r,n);if('string'==typeof a&&!Z(a,n)){n.showRetryToast&&toastr.warning('Response missing required content. Retrying...'),i=new Error('Content validation failed'),await ne(d,n,!1);continue}return n.showSuccessToast&&toastr.success(`Auto-retry succeeded with fallback model: ${t.model}`),{success:!0,result:a,attempts:d,usedFallback:m,fallbackModel:s}}catch(e){if(i=e,console.warn(`[auto-retry] Fallback ${f+1} attempt ${d} failed:`,e),r.aborted)return{success:!1,error:new Error('Aborted by user'),attempts:d,usedFallback:m,fallbackModel:s};if(!X(e))break;if(d>=p)break;await ne(d,n,Q(e))}}}n.showFailureToast&&toastr.error('Auto-retry failed after all attempts');return{success:!1,error:i,attempts:d,usedFallback:m,fallbackModel:s}}(e,t,n,s,r,a,l);return o}finally{J.delete(o)}}async function te(e,t,n){return new Promise((r,a)=>{let l,o=!1;const i=()=>{o=!0,l&&clearInterval(l)};t.isStreaming&&(l=setInterval(()=>{if(o||t.aborted)return void i();const e=Date.now()-t.lastTokenTime;t.hasReceivedContent&&e>n.streamingTimeoutMs&&(i(),stopGenerationById(t.generationId).catch(()=>{}),n.showRetryToast&&toastr.warning('Streaming timeout. Retrying...'),a(new Error('Streaming timeout')))},1e3)),e.then(e=>{o||(i(),r(e))}).catch(e=>{o||(i(),a(e))})})}async function ne(e,t,n){const r=function(e,t,n){return n?t.rateLimitDelayMs:t.retryDelayMs*Math.pow(t.retryDelayMultiplier,e-1)}(e,t,n);var a;await(a=r,new Promise(e=>setTimeout(e,a)))}let re=null,ae=null,le=null,oe=null,ie=!1;function se(){ie||(re=generate,ae=generateRaw,window.generate=de,window.generateRaw=ce,le=eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY,(e,t)=>{!function(e){const t=J.get(e);t&&(t.lastTokenTime=Date.now(),t.hasReceivedContent=!0)}(t)}),oe=eventOn(tavern_events.GENERATION_STOPPED,()=>{}),ie=!0,console.info('[auto-retry] Interceptor installed'))}async function de(e){const t=u();if(!t.settings.enabled||!re)return re(e);const n=await ee(()=>re(e),e,t.settings,re,ae,!1);if(n.success)return n.result;throw n.error}async function ce(e){const t=u();if(!t.settings.enabled||!ae)return ae(e);const n=await ee(()=>ae(e),e,t.settings,re,ae,!0);if(n.success)return n.result;throw n.error}$(()=>{const t=e(),n=(0,i.createApp)(Y).use(t),r=$('<div>').attr('script_id',getScriptId()).appendTo('#extensions_settings2');n.mount(r[0]);const{destroy:a}=function(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}(),l=u(t);se(),replaceScriptButtons([{name:'Toggle Auto-Retry',visible:!0}]),eventOn(getButtonEvent('Toggle Auto-Retry'),()=>{l.toggle(),l.settings.enabled?toastr.success('Auto-Retry Enabled'):toastr.warning('Auto-Retry Disabled')}),$(window).on('pagehide',()=>{ie&&(re&&(window.generate=re,re=null),ae&&(window.generateRaw=ae,ae=null),le&&(le.stop(),le=null),oe&&(oe.stop(),oe=null),ie=!1,console.info('[auto-retry] Interceptor uninstalled')),n.unmount(),r.remove(),a()})});
//# sourceMappingURL=index.js.map